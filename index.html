<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prompt æç¤ºè©ç®¡ç†ç³»çµ± v3</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif; background: #f0f2f5; color: #333; }
  .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
  .header h1 { font-size: 24px; margin-bottom: 5px; }
  .header p { font-size: 14px; opacity: 0.9; }
  .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
  .analyze-box { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .analyze-box h2 { font-size: 18px; margin-bottom: 15px; color: #4a5568; }
  .analyze-box textarea { width: 100%; height: 180px; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 14px; resize: vertical; font-family: inherit; }
  .analyze-box textarea:focus { border-color: #667eea; outline: none; }
  .analyze-box input[type="text"] { width: 100%; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px 12px; font-size: 14px; margin-bottom: 10px; }
  .analyze-box input[type="text"]:focus { border-color: #667eea; outline: none; }
  .analyze-box select { width: 100%; border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px 12px; font-size: 14px; margin-bottom: 10px; background: white; }
  .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
  .form-row select { flex: 1; }
  .btn { padding: 10px 24px; border: none; border-radius: 8px; font-size: 15px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
  .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
  .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
  .btn-success { background: #48bb78; color: white; }
  .btn-success:hover { background: #38a169; }
  .btn-sm { padding: 6px 14px; font-size: 13px; }
  .btn-outline { background: white; color: #667eea; border: 2px solid #667eea; }
  .btn-outline:hover { background: #667eea; color: white; }
  .btn-row { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
  .ai-results { margin-top: 20px; }
  .ai-result-card { background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
  .ai-result-card h4 { color: #2d3748; margin-bottom: 8px; }
  .ai-result-card pre { background: #edf2f7; padding: 10px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; margin-bottom: 8px; max-height: 200px; overflow-y: auto; }
  .ai-result-card .meta { font-size: 12px; color: #718096; }
  .ai-result-card .meta span { background: #e2e8f0; padding: 2px 8px; border-radius: 10px; margin-right: 5px; display: inline-block; margin-bottom: 4px; }
  .ai-result-card .meta .tool-badge { background: #ebf4ff; color: #3182ce; border: 1px solid #90cdf4; }
  .filter-bar { background: white; border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .filter-bar input { flex: 1; min-width: 200px; border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 14px; }
  .filter-bar select { border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 14px; background: white; }
  .prompt-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px; }
  .prompt-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.2s; }
  .prompt-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
  .prompt-card .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 8px; }
  .prompt-card .card-title { font-size: 16px; font-weight: 600; color: #2d3748; flex: 1; }
  .prompt-card .card-badges { display: flex; gap: 6px; flex-shrink: 0; flex-wrap: wrap; justify-content: flex-end; }
  .prompt-card .card-category { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; white-space: nowrap; }
  .prompt-card .card-tool { background: #ebf4ff; color: #2b6cb0; padding: 3px 10px; border-radius: 12px; font-size: 12px; white-space: nowrap; border: 1px solid #90cdf4; }
  .prompt-card .card-content { background: #f7fafc; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.6; margin-bottom: 10px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
  .prompt-card .card-tags span { background: #edf2f7; color: #4a5568; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-right: 4px; display: inline-block; margin-bottom: 4px; }
  .prompt-card .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid #edf2f7; }
  .prompt-card .card-source { font-size: 11px; color: #a0aec0; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .prompt-card .card-actions { display: flex; gap: 6px; }
  .prompt-card .card-actions button { background: none; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px 10px; font-size: 12px; cursor: pointer; transition: all 0.2s; }
  .prompt-card .card-actions button:hover { background: #edf2f7; }
  .stats { text-align: center; color: #a0aec0; padding: 20px; font-size: 14px; }
  .status-msg { padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 14px; }
  .status-msg.info { background: #ebf8ff; color: #2b6cb0; }
  .status-msg.success { background: #f0fff4; color: #276749; }
  .status-msg.error { background: #fff5f5; color: #c53030; }
  .status-msg.loading { background: #fefcbf; color: #975a16; }
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 550px; max-height: 90vh; overflow-y: auto; }
  .modal h3 { margin-bottom: 16px; color: #2d3748; }
  .modal label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; margin-top: 12px; color: #4a5568; }
  .modal input, .modal textarea, .modal select { width: 100%; border: 2px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-family: inherit; }
  .modal textarea { height: 100px; resize: vertical; }
  .modal .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
  .tools-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .tools-bar .settings-btn { background: #edf2f7; color: #4a5568; border: 1px solid #e2e8f0; padding: 6px 14px; border-radius: 8px; font-size: 13px; cursor: pointer; }
  .tools-bar .settings-btn:hover { background: #e2e8f0; }
  /* ç®¡ç†åˆ†é¡ Modal */
  .manage-section { margin-bottom: 20px; }
  .manage-section h4 { font-size: 15px; color: #4a5568; margin-bottom: 10px; }
  .manage-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
  .manage-item { display: flex; align-items: center; gap: 4px; background: #edf2f7; padding: 4px 10px; border-radius: 16px; font-size: 13px; }
  .manage-item.tool-item { background: #ebf4ff; color: #2b6cb0; }
  .manage-item.cat-item { background: #f0e6ff; color: #6b46c1; }
  .manage-item button { background: none; border: none; color: #e53e3e; cursor: pointer; font-size: 14px; padding: 0 2px; font-weight: bold; }
  .manage-item button:hover { color: #c53030; }
  .manage-add { display: flex; gap: 8px; }
  .manage-add input { flex: 1; border: 2px solid #e2e8f0; border-radius: 8px; padding: 6px 10px; font-size: 13px; }
  .manage-add button { background: #48bb78; color: white; border: none; border-radius: 8px; padding: 6px 16px; font-size: 13px; cursor: pointer; white-space: nowrap; }
  .manage-add button:hover { background: #38a169; }
  @media (max-width: 600px) {
    .prompt-grid { grid-template-columns: 1fr; }
    .filter-bar { flex-direction: column; }
    .btn-row { flex-direction: column; }
    .form-row { flex-direction: column; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“‹ Prompt æç¤ºè©ç®¡ç†ç³»çµ± v3</h1>
  <p>Supabase é›²ç«¯ç‰ˆ â€” ä»»ä½•è£ç½®ã€ä»»ä½•åœ°æ–¹éƒ½èƒ½ç”¨</p>
</div>

<div class="container">
  <div class="analyze-box">
    <h2>ğŸ¤– è²¼ä¸Šæ–‡ç« å…§å®¹ï¼ŒAI è‡ªå‹•æ“·å–æç¤ºè©</h2>
    <input type="text" id="articleTitle" placeholder="æ–‡ç« æ¨™é¡Œï¼ˆé¸å¡«ï¼‰">
    <input type="text" id="articleSource" placeholder="ä¾†æºç¶²å€ï¼ˆé¸å¡«ï¼‰ï¼Œä¾‹å¦‚ https://www.koc.com.tw/archives/630020">
    <div class="form-row">
      <select id="articleTool"></select>
      <select id="articleCategory"></select>
    </div>
    <textarea id="articleContent" placeholder="æŠŠæ–‡ç« å…§å®¹è²¼åœ¨é€™è£¡...&#10;&#10;æ­¥é©Ÿï¼š&#10;1. æ‰“é–‹æ–‡ç« ç¶²é &#10;2. Ctrl+A å…¨é¸æ–‡å­—&#10;3. Ctrl+C è¤‡è£½&#10;4. åœ¨é€™è£¡ Ctrl+V è²¼ä¸Š&#10;5. æŒ‰ä¸‹ã€ŒAI åˆ†ææç¤ºè©ã€æŒ‰éˆ•"></textarea>
    <div class="btn-row">
      <button class="btn btn-primary" id="btnAnalyze" onclick="analyzeWithAI()">ğŸ¤– AI åˆ†ææç¤ºè©</button>
      <button class="btn btn-outline" onclick="openAddModal()">âœï¸ æ‰‹å‹•æ–°å¢</button>
    </div>
    <div id="statusMsg"></div>
    <div id="aiResults" class="ai-results"></div>
  </div>

  <div class="tools-bar">
    <button class="btn btn-sm btn-outline" onclick="exportJSON()">ğŸ“¤ åŒ¯å‡º JSON</button>
    <button class="btn btn-sm btn-outline" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥ JSON</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importJSON(event)">
    <button class="btn btn-sm btn-outline" onclick="exportCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
    <button class="settings-btn" onclick="openManageModal()">âš™ï¸ ç®¡ç†åˆ†é¡</button>
    <button class="settings-btn" onclick="resetApiKey()">ğŸ”‘ é‡è¨­ API Key</button>
  </div>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹æ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤..." oninput="renderPrompts()">
    <select id="toolFilter" onchange="renderPrompts()"></select>
    <select id="categoryFilter" onchange="renderPrompts()"></select>
  </div>

  <div id="promptGrid" class="prompt-grid"></div>
  <div id="stats" class="stats"></div>
</div>

<!-- æ–°å¢/ç·¨è¼¯ Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h3 id="modalTitle">æ–°å¢æç¤ºè©</h3>
    <input type="hidden" id="editId">
    <label>æ¨™é¡Œ *</label>
    <input type="text" id="formTitle" placeholder="æç¤ºè©åç¨±">
    <label>å…§å®¹ *</label>
    <textarea id="formContent" placeholder="æç¤ºè©å…§å®¹"></textarea>
    <label>AI å·¥å…·</label>
    <select id="formTool"></select>
    <label>ç”¨é€”åˆ†é¡</label>
    <select id="formCategory"></select>
    <label>æ¨™ç±¤ï¼ˆç”¨é€—è™Ÿåˆ†éš”ï¼‰</label>
    <input type="text" id="formTags" placeholder="ä¾‹å¦‚ï¼šNotebookLM, ç°¡å ±, AI">
    <label>ä¾†æºç¶²å€</label>
    <input type="text" id="formSource" placeholder="https://...">
    <label>å‚™è¨»</label>
    <textarea id="formNotes" style="height:60px" placeholder="å‚™è¨»..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="savePrompt()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- ç®¡ç†åˆ†é¡ Modal -->
<div class="modal-overlay" id="manageModalOverlay" onclick="if(event.target===this)closeManageModal()">
  <div class="modal">
    <h3>âš™ï¸ ç®¡ç†åˆ†é¡é¸é …</h3>

    <div class="manage-section">
      <h4>ğŸ›  AI å·¥å…·</h4>
      <div class="manage-list" id="toolList"></div>
      <div class="manage-add">
        <input type="text" id="newToolInput" placeholder="è¼¸å…¥æ–°çš„ AI å·¥å…·åç¨±">
        <button onclick="addTool()">ï¼‹ æ–°å¢</button>
      </div>
    </div>

    <div class="manage-section">
      <h4>ğŸ“‚ ç”¨é€”åˆ†é¡</h4>
      <div class="manage-list" id="catList"></div>
      <div class="manage-add">
        <input type="text" id="newCatInput" placeholder="è¼¸å…¥æ–°çš„åˆ†é¡åç¨±">
        <button onclick="addCategory()">ï¼‹ æ–°å¢</button>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-primary" onclick="closeManageModal()">å®Œæˆ</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// âš ï¸ è«‹æŠŠä¸‹é¢å…©è¡Œæ›æˆä½ è‡ªå·±çš„ Supabase é‡‘é‘°
// ============================================================
var SUPABASE_URL = 'https://xuxkvlpjzqwgcqxbknsw.supabase.co';
var SUPABASE_KEY = 'sb_publishable_OqLTc65lo0kXjjz6Kw186w_hJzbUrOv';
var CLAUDE_API_KEY = localStorage.getItem('claude_api_key') || '';

var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
var allPrompts = [];

// ============================================================
// å¯è‡ªè¨‚çš„åˆ†é¡æ¸…å–®ï¼ˆå­˜åœ¨ localStorageï¼‰
// ============================================================
var defaultTools = ['Gemini','Claude','ChatGPT','NotebookLM','Copilot','Perplexity','Grok','Midjourney','Stable Diffusion','Cursor','è‡ªå‹•åŒ–','ç¨‹å¼é–‹ç™¼'];
var defaultCategories = ['å¯«ä½œ','ç¨‹å¼é–‹ç™¼','è¡ŒéŠ·','åˆ†æ','æ•™è‚²','ç¿»è­¯','å‰µæ„','å•†æ¥­','ç”Ÿæ´»','ç°¡å ±','è§’è‰²æ‰®æ¼”','è‡ªå‹•åŒ–'];

function getTools() {
  var saved = localStorage.getItem('prompt_tools');
  return saved ? JSON.parse(saved) : defaultTools.slice();
}
function setTools(list) {
  localStorage.setItem('prompt_tools', JSON.stringify(list));
}
function getCategories() {
  var saved = localStorage.getItem('prompt_categories');
  return saved ? JSON.parse(saved) : defaultCategories.slice();
}
function setCategories(list) {
  localStorage.setItem('prompt_categories', JSON.stringify(list));
}

// ============================================================
// å‹•æ…‹ç”¢ç”Ÿæ‰€æœ‰ä¸‹æ‹‰é¸å–®
// ============================================================
function refreshAllDropdowns() {
  var tools = getTools();
  var cats = getCategories();

  // AI å·¥å…·é¸å–®
  var toolSelects = ['articleTool','formTool'];
  for (var s = 0; s < toolSelects.length; s++) {
    var el = document.getElementById(toolSelects[s]);
    if (!el) continue;
    var val = el.value;
    el.innerHTML = '<option value="">-- é¸æ“‡ AI å·¥å…· --</option>';
    for (var i = 0; i < tools.length; i++) {
      el.innerHTML += '<option value="' + escHtml(tools[i]) + '">' + escHtml(tools[i]) + '</option>';
    }
    el.innerHTML += '<option value="å…¶ä»–">å…¶ä»–</option>';
    el.value = val;
  }

  // å·¥å…·ç¯©é¸å™¨
  var toolFilterEl = document.getElementById('toolFilter');
  if (toolFilterEl) {
    var val = toolFilterEl.value;
    toolFilterEl.innerHTML = '<option value="">å…¨éƒ¨å·¥å…·</option>';
    for (var i = 0; i < tools.length; i++) {
      toolFilterEl.innerHTML += '<option value="' + escHtml(tools[i]) + '">' + escHtml(tools[i]) + '</option>';
    }
    toolFilterEl.value = val;
  }

  // ç”¨é€”åˆ†é¡é¸å–®
  var catSelects = ['articleCategory','formCategory'];
  for (var s = 0; s < catSelects.length; s++) {
    var el = document.getElementById(catSelects[s]);
    if (!el) continue;
    var val = el.value;
    el.innerHTML = '<option value="">-- é¸æ“‡ç”¨é€”åˆ†é¡ --</option>';
    for (var i = 0; i < cats.length; i++) {
      el.innerHTML += '<option value="' + escHtml(cats[i]) + '">' + escHtml(cats[i]) + '</option>';
    }
    el.innerHTML += '<option value="å…¶ä»–">å…¶ä»–</option>';
    el.value = val;
  }

  // åˆ†é¡ç¯©é¸å™¨
  var catFilterEl = document.getElementById('categoryFilter');
  if (catFilterEl) {
    var val = catFilterEl.value;
    catFilterEl.innerHTML = '<option value="">å…¨éƒ¨åˆ†é¡</option>';
    for (var i = 0; i < cats.length; i++) {
      catFilterEl.innerHTML += '<option value="' + escHtml(cats[i]) + '">' + escHtml(cats[i]) + '</option>';
    }
    catFilterEl.innerHTML += '<option value="å…¶ä»–">å…¶ä»–</option>';
    catFilterEl.value = val;
  }
}

// ============================================================
// ç®¡ç†åˆ†é¡ Modal
// ============================================================
function openManageModal() {
  document.getElementById('manageModalOverlay').classList.add('active');
  renderManageLists();
}
function closeManageModal() {
  document.getElementById('manageModalOverlay').classList.remove('active');
  refreshAllDropdowns();
  renderPrompts();
}
function renderManageLists() {
  var tools = getTools();
  var cats = getCategories();
  var toolHtml = '';
  for (var i = 0; i < tools.length; i++) {
    toolHtml += '<div class="manage-item tool-item">' + escHtml(tools[i]) +
      ' <button onclick="removeTool(' + i + ')" title="åˆªé™¤">âœ•</button></div>';
  }
  document.getElementById('toolList').innerHTML = toolHtml || '<span style="color:#a0aec0;font-size:13px">å°šç„¡é …ç›®</span>';
  var catHtml = '';
  for (var i = 0; i < cats.length; i++) {
    catHtml += '<div class="manage-item cat-item">' + escHtml(cats[i]) +
      ' <button onclick="removeCategory(' + i + ')" title="åˆªé™¤">âœ•</button></div>';
  }
  document.getElementById('catList').innerHTML = catHtml || '<span style="color:#a0aec0;font-size:13px">å°šç„¡é …ç›®</span>';
}
function addTool() {
  var input = document.getElementById('newToolInput');
  var name = input.value.trim();
  if (!name) return;
  var tools = getTools();
  if (tools.indexOf(name) >= 0) { alert('ã€Œ' + name + 'ã€å·²ç¶“å­˜åœ¨'); return; }
  tools.push(name);
  setTools(tools);
  input.value = '';
  renderManageLists();
}
function removeTool(index) {
  var tools = getTools();
  var name = tools[index];
  if (!confirm('ç¢ºå®šè¦åˆªé™¤ã€Œ' + name + 'ã€å—ï¼Ÿ')) return;
  tools.splice(index, 1);
  setTools(tools);
  renderManageLists();
}
function addCategory() {
  var input = document.getElementById('newCatInput');
  var name = input.value.trim();
  if (!name) return;
  var cats = getCategories();
  if (cats.indexOf(name) >= 0) { alert('ã€Œ' + name + 'ã€å·²ç¶“å­˜åœ¨'); return; }
  cats.push(name);
  setCategories(cats);
  input.value = '';
  renderManageLists();
}
function removeCategory(index) {
  var cats = getCategories();
  var name = cats[index];
  if (!confirm('ç¢ºå®šè¦åˆªé™¤ã€Œ' + name + 'ã€å—ï¼Ÿ')) return;
  cats.splice(index, 1);
  setCategories(cats);
  renderManageLists();
}

// ============================================================
// é é¢è¼‰å…¥
// ============================================================
window.addEventListener('DOMContentLoaded', async function() {
  refreshAllDropdowns();
  await loadPrompts();
});

async function loadPrompts() {
  var result = await db.from('prompts').select('*').order('created_at', { ascending: false });
  if (result.error) {
    showStatus('è¼‰å…¥è³‡æ–™å¤±æ•—ï¼š' + result.error.message, 'error');
    return;
  }
  allPrompts = result.data || [];
  renderPrompts();
}

function renderPrompts() {
  var keyword = document.getElementById('searchInput').value.toLowerCase();
  var catFilter = document.getElementById('categoryFilter').value;
  var toolFilter = document.getElementById('toolFilter').value;
  var filtered = allPrompts.filter(function(p) {
    var matchKeyword = !keyword ||
      (p.title && p.title.toLowerCase().indexOf(keyword) >= 0) ||
      (p.content && p.content.toLowerCase().indexOf(keyword) >= 0) ||
      (p.tags && p.tags.some(function(t) { return t.toLowerCase().indexOf(keyword) >= 0; })) ||
      (p.tool && p.tool.toLowerCase().indexOf(keyword) >= 0) ||
      (p.notes && p.notes.toLowerCase().indexOf(keyword) >= 0);
    var matchCat = !catFilter || p.category === catFilter;
    var matchTool = !toolFilter || p.tool === toolFilter;
    return matchKeyword && matchCat && matchTool;
  });
  var grid = document.getElementById('promptGrid');
  if (filtered.length === 0) {
    grid.innerHTML = '<div class="stats">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„æç¤ºè©</div>';
    document.getElementById('stats').textContent = 'å…± ' + allPrompts.length + ' æ¢æç¤ºè©';
    return;
  }
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var p = filtered[i];
    var tagsHtml = '';
    if (p.tags) { for (var j = 0; j < p.tags.length; j++) { tagsHtml += '<span>' + escHtml(p.tags[j]) + '</span>'; } }
    var toolBadge = p.tool ? '<div class="card-tool">ğŸ›  ' + escHtml(p.tool) + '</div>' : '';
    html += '<div class="prompt-card">' +
      '<div class="card-header">' +
        '<div class="card-title">' + escHtml(p.title) + '</div>' +
        '<div class="card-badges">' + toolBadge +
          '<div class="card-category">' + escHtml(p.category || 'å…¶ä»–') + '</div>' +
        '</div>' +
      '</div>' +
      '<div class="card-content">' + escHtml(p.content) + '</div>' +
      '<div class="card-tags">' + tagsHtml + '</div>' +
      '<div class="card-footer">' +
        '<div class="card-source" title="' + escHtml(p.source || '') + '">' + (p.source ? 'ğŸ”— ' + escHtml(p.source) : '') + '</div>' +
        '<div class="card-actions">' +
          '<button onclick="copyContent(' + p.id + ')" title="è¤‡è£½">ğŸ“‹</button>' +
          '<button onclick="openEditModal(' + p.id + ')" title="ç·¨è¼¯">âœï¸</button>' +
          '<button onclick="deletePrompt(' + p.id + ')" title="åˆªé™¤">ğŸ—‘ï¸</button>' +
        '</div>' +
      '</div>' +
    '</div>';
  }
  grid.innerHTML = html;
  document.getElementById('stats').textContent = 'é¡¯ç¤º ' + filtered.length + ' / å…± ' + allPrompts.length + ' æ¢æç¤ºè©';
}

async function analyzeWithAI() {
  var content = document.getElementById('articleContent').value.trim();
  var title = document.getElementById('articleTitle').value.trim();
  var source = document.getElementById('articleSource').value.trim();
  var tool = document.getElementById('articleTool').value;
  var category = document.getElementById('articleCategory').value;
  if (!content) { showStatus('è«‹å…ˆè²¼ä¸Šæ–‡ç« å…§å®¹ï¼', 'error'); return; }
  if (content.length < 50) { showStatus('æ–‡ç« å…§å®¹å¤ªçŸ­ï¼Œè‡³å°‘éœ€è¦ 50 å€‹å­—', 'error'); return; }
  if (!CLAUDE_API_KEY) {
    var key = prompt('è«‹è¼¸å…¥ä½ çš„ Claude API Keyï¼ˆsk-ant-api03-...ï¼‰ï¼š');
    if (!key) return;
    CLAUDE_API_KEY = key.trim();
    localStorage.setItem('claude_api_key', CLAUDE_API_KEY);
  }
  var btn = document.getElementById('btnAnalyze');
  btn.disabled = true;
  btn.textContent = 'â³ AI åˆ†æä¸­...';
  showStatus('æ­£åœ¨å‘¼å« AI åˆ†ææ–‡ç« ä¸­çš„æç¤ºè©ï¼Œè«‹ç¨å€™ç´„ 10-20 ç§’...', 'loading');
  try {
    var tools = getTools();
    var cats = getCategories();
    var textToAnalyze = content.substring(0, 8000);
    var response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': CLAUDE_API_KEY,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20241022',
        max_tokens: 4096,
        messages: [{
          role: 'user',
          content: 'è«‹åˆ†æä»¥ä¸‹æ–‡ç« ï¼Œæ‰¾å‡ºæ‰€æœ‰ã€Œæç¤ºè©ï¼ˆPromptï¼‰ã€ã€‚\n\nè¦å‰‡ï¼š\n1. åªæå–æ–‡ç« ä¸­æ˜ç¢ºçš„æç¤ºè©/æŒ‡ä»¤ï¼Œä¸è¦æå–ä½œè€…çš„èªªæ˜æ–‡å­—\n2. æ¯å€‹æç¤ºè©ä¿ç•™åŸæ–‡ï¼Œä¸è¦æ”¹å¯«\n3. ç‚ºæ¯å€‹æç¤ºè©åˆ†é…ç”¨é€”åˆ†é¡ï¼Œå¾ä»¥ä¸‹é¸æ“‡ï¼š' + cats.join('/') + '/å…¶ä»–\n4. ç‚ºæ¯å€‹æç¤ºè©ç”¢ç”Ÿ 2-4 å€‹æ¨™ç±¤\n5. åˆ¤æ–·é€™äº›æç¤ºè©é©ç”¨æ–¼å“ªå€‹ AI å·¥å…·ï¼Œå¾ä»¥ä¸‹é¸æ“‡ï¼š' + tools.join('/') + '/å…¶ä»–\n6. å¦‚æœæ–‡ç« ä¸­æ²’æœ‰æç¤ºè©ï¼Œå›å‚³ç©ºé™£åˆ—\n\nè«‹ç”¨ JSON æ ¼å¼å›è¦†ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—ï¼š\n{"prompts":[{"title":"æç¤ºè©åç¨±","content":"å®Œæ•´æç¤ºè©å…§å®¹","category":"ç”¨é€”åˆ†é¡","tool":"AIå·¥å…·åç¨±","tags":["æ¨™ç±¤1","æ¨™ç±¤2"]}]}\n\næ–‡ç« å…§å®¹ï¼š\n' + textToAnalyze
        }]
      })
    });
    if (!response.ok) {
      var errData = {};
      try { errData = await response.json(); } catch(e) {}
      throw new Error('API éŒ¯èª¤ ' + response.status + ': ' + (errData.error ? errData.error.message : response.statusText));
    }
    var data = await response.json();
    var aiText = data.content[0].text;
    var parsed;
    try {
      var jsonMatch = aiText.match(/\{[\s\S]*\}/);
      parsed = JSON.parse(jsonMatch ? jsonMatch[0] : aiText);
    } catch (e) {
      throw new Error('AI å›å‚³æ ¼å¼ç„¡æ³•è§£æ');
    }
    var prompts = parsed.prompts || [];
    if (prompts.length === 0) {
      showStatus('AI æ²’æœ‰åœ¨æ–‡ç« ä¸­æ‰¾åˆ°æ˜ç¢ºçš„æç¤ºè©ã€‚ä½ å¯ä»¥ç”¨ã€Œæ‰‹å‹•æ–°å¢ã€ä¾†è‡ªå·±è¼¸å…¥ã€‚', 'info');
      document.getElementById('aiResults').innerHTML = '';
      return;
    }
    showStatus('âœ… AI æ‰¾åˆ° ' + prompts.length + ' å€‹æç¤ºè©ï¼Œè«‹å‹¾é¸å¾Œå„²å­˜ï¼š', 'success');
    var resultsHtml = '';
    for (var i = 0; i < prompts.length; i++) {
      var p = prompts[i];
      var tagsMeta = '';
      if (p.tags) { for (var j = 0; j < p.tags.length; j++) { tagsMeta += '<span>ğŸ·ï¸ ' + escHtml(p.tags[j]) + '</span>'; } }
      var aiTool = tool || p.tool || '';
      var aiCat = category || p.category || 'å…¶ä»–';
      resultsHtml += '<div class="ai-result-card">' +
        '<label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer">' +
          '<input type="checkbox" checked data-index="' + i + '" style="margin-top:4px;transform:scale(1.3)">' +
          '<div style="flex:1">' +
            '<h4>' + escHtml(p.title) + '</h4>' +
            '<pre>' + escHtml(p.content) + '</pre>' +
            '<div class="meta">' +
              (aiTool ? '<span class="tool-badge">ğŸ›  ' + escHtml(aiTool) + '</span>' : '') +
              '<span>ğŸ“‚ ' + escHtml(aiCat) + '</span>' + tagsMeta +
            '</div>' +
          '</div>' +
        '</label>' +
      '</div>';
    }
    resultsHtml += '<div class="btn-row" style="margin-top:16px"><button class="btn btn-success" onclick="saveAIResults()">ğŸ’¾ å„²å­˜å‹¾é¸çš„æç¤ºè©</button></div>';
    document.getElementById('aiResults').innerHTML = resultsHtml;
    window._aiPrompts = [];
    for (var i = 0; i < prompts.length; i++) {
      window._aiPrompts.push({
        title: prompts[i].title, content: prompts[i].content,
        category: category || prompts[i].category || 'å…¶ä»–',
        tool: tool || prompts[i].tool || '',
        tags: prompts[i].tags, source: source,
        notes: title ? 'ä¾†è‡ªæ–‡ç« ï¼š' + title : ''
      });
    }
  } catch (err) {
    showStatus('åˆ†æå¤±æ•—ï¼š' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ¤– AI åˆ†ææç¤ºè©';
  }
}

async function saveAIResults() {
  if (!window._aiPrompts) return;
  var checkboxes = document.querySelectorAll('#aiResults input[type="checkbox"]');
  var selected = [];
  for (var i = 0; i < checkboxes.length; i++) {
    if (checkboxes[i].checked) selected.push(window._aiPrompts[parseInt(checkboxes[i].dataset.index)]);
  }
  if (selected.length === 0) { showStatus('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹æç¤ºè©', 'error'); return; }
  showStatus('æ­£åœ¨å„²å­˜ ' + selected.length + ' å€‹æç¤ºè©...', 'loading');
  var rows = [];
  for (var i = 0; i < selected.length; i++) {
    rows.push({ title: selected[i].title, content: selected[i].content,
      category: selected[i].category || 'å…¶ä»–', tool: selected[i].tool || '',
      tags: selected[i].tags || [], source: selected[i].source || '', notes: selected[i].notes || '' });
  }
  var result = await db.from('prompts').insert(rows);
  if (result.error) { showStatus('å„²å­˜å¤±æ•—ï¼š' + result.error.message, 'error'); return; }
  showStatus('âœ… æˆåŠŸå„²å­˜ ' + selected.length + ' å€‹æç¤ºè©ï¼', 'success');
  document.getElementById('aiResults').innerHTML = '';
  document.getElementById('articleContent').value = '';
  document.getElementById('articleTitle').value = '';
  document.getElementById('articleSource').value = '';
  window._aiPrompts = null;
  await loadPrompts();
}

function openAddModal() {
  document.getElementById('modalTitle').textContent = 'æ–°å¢æç¤ºè©';
  document.getElementById('editId').value = '';
  document.getElementById('formTitle').value = '';
  document.getElementById('formContent').value = '';
  document.getElementById('formTool').value = '';
  document.getElementById('formCategory').value = '';
  document.getElementById('formTags').value = '';
  document.getElementById('formSource').value = '';
  document.getElementById('formNotes').value = '';
  document.getElementById('modalOverlay').classList.add('active');
}

function openEditModal(id) {
  var p = null;
  for (var i = 0; i < allPrompts.length; i++) { if (allPrompts[i].id === id) { p = allPrompts[i]; break; } }
  if (!p) return;
  document.getElementById('modalTitle').textContent = 'ç·¨è¼¯æç¤ºè©';
  document.getElementById('editId').value = id;
  document.getElementById('formTitle').value = p.title;
  document.getElementById('formContent').value = p.content;
  document.getElementById('formTool').value = p.tool || '';
  document.getElementById('formCategory').value = p.category || '';
  document.getElementById('formTags').value = (p.tags || []).join(', ');
  document.getElementById('formSource').value = p.source || '';
  document.getElementById('formNotes').value = p.notes || '';
  document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

async function savePrompt() {
  var title = document.getElementById('formTitle').value.trim();
  var content = document.getElementById('formContent').value.trim();
  if (!title || !content) { alert('æ¨™é¡Œå’Œå…§å®¹ç‚ºå¿…å¡«'); return; }
  var tagsRaw = document.getElementById('formTags').value.split(',');
  var tags = [];
  for (var i = 0; i < tagsRaw.length; i++) { var t = tagsRaw[i].trim(); if (t) tags.push(t); }
  var row = { title: title, content: content,
    tool: document.getElementById('formTool').value,
    category: document.getElementById('formCategory').value || 'å…¶ä»–',
    tags: tags, source: document.getElementById('formSource').value.trim(),
    notes: document.getElementById('formNotes').value.trim(),
    updated_at: new Date().toISOString() };
  var editId = document.getElementById('editId').value;
  if (editId) {
    var result = await db.from('prompts').update(row).eq('id', parseInt(editId));
    if (result.error) { alert('æ›´æ–°å¤±æ•—ï¼š' + result.error.message); return; }
  } else {
    var result = await db.from('prompts').insert(row);
    if (result.error) { alert('æ–°å¢å¤±æ•—ï¼š' + result.error.message); return; }
  }
  closeModal();
  await loadPrompts();
}

async function deletePrompt(id) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™æ¢æç¤ºè©å—ï¼Ÿ')) return;
  var result = await db.from('prompts').delete().eq('id', id);
  if (result.error) { alert('åˆªé™¤å¤±æ•—ï¼š' + result.error.message); return; }
  await loadPrompts();
}

function copyContent(id) {
  var p = null;
  for (var i = 0; i < allPrompts.length; i++) { if (allPrompts[i].id === id) { p = allPrompts[i]; break; } }
  if (!p) return;
  navigator.clipboard.writeText(p.content).then(function() {
    showStatus('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
    setTimeout(function() { document.getElementById('statusMsg').innerHTML = ''; }, 2000);
  });
}

function resetApiKey() {
  localStorage.removeItem('claude_api_key');
  CLAUDE_API_KEY = '';
  showStatus('âœ… API Key å·²æ¸…é™¤ï¼Œä¸‹æ¬¡åˆ†ææ™‚æœƒé‡æ–°è©¢å•', 'success');
}

function exportJSON() {
  var blob = new Blob([JSON.stringify(allPrompts, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a'); a.href = url;
  a.download = 'prompts-backup-' + new Date().toISOString().slice(0,10) + '.json';
  a.click(); URL.revokeObjectURL(url);
}

async function importJSON(event) {
  var file = event.target.files[0]; if (!file) return;
  try {
    var text = await file.text();
    var imported = JSON.parse(text);
    if (!Array.isArray(imported)) throw new Error('æ ¼å¼ä¸æ­£ç¢º');
    var rows = [];
    for (var i = 0; i < imported.length; i++) {
      rows.push({ title: imported[i].title || 'æœªå‘½å', content: imported[i].content || '',
        tool: imported[i].tool || '', category: imported[i].category || 'å…¶ä»–',
        tags: Array.isArray(imported[i].tags) ? imported[i].tags : [],
        source: imported[i].source || '', notes: imported[i].notes || '' });
    }
    var result = await db.from('prompts').insert(rows);
    if (result.error) throw result.error;
    showStatus('âœ… æˆåŠŸåŒ¯å…¥ ' + rows.length + ' æ¢æç¤ºè©ï¼', 'success');
    await loadPrompts();
  } catch (err) { showStatus('åŒ¯å…¥å¤±æ•—ï¼š' + err.message, 'error'); }
  event.target.value = '';
}

function exportCSV() {
  var header = 'æ¨™é¡Œ,å…§å®¹,AIå·¥å…·,åˆ†é¡,æ¨™ç±¤,ä¾†æº,å‚™è¨»,å»ºç«‹æ™‚é–“\n';
  var rows = '';
  for (var i = 0; i < allPrompts.length; i++) {
    var p = allPrompts[i];
    rows += '"' + csvEsc(p.title) + '","' + csvEsc(p.content) + '","' + csvEsc(p.tool) + '","' + csvEsc(p.category) + '","' + csvEsc((p.tags||[]).join('|')) + '","' + csvEsc(p.source) + '","' + csvEsc(p.notes) + '","' + p.created_at + '"\n';
  }
  var blob = new Blob(['\uFEFF' + header + rows], { type: 'text/csv;charset=utf-8' });
  var url = URL.createObjectURL(blob); var a = document.createElement('a'); a.href = url;
  a.download = 'prompts-' + new Date().toISOString().slice(0,10) + '.csv';
  a.click(); URL.revokeObjectURL(url);
}

function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function csvEsc(str) { return (str || '').replace(/"/g, '""'); }
function showStatus(msg, type) {
  document.getElementById('statusMsg').innerHTML = '<div class="status-msg ' + type + '">' + msg + '</div>';
}
</script>
</body>
</html>